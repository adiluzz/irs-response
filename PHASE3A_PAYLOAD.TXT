===== FILE: /app/notice/page.tsx =====
import NoticeWizard from '../../components/NoticeWizard'

export default function NoticePage() {
  return (
    <main style={{ padding: 24, maxWidth: 1100, margin: '0 auto' }}>
      <h1 style={{ fontSize: 28, fontWeight: 700, marginBottom: 8 }}>TAC Response — Notice Wizard</h1>
      <p style={{ marginBottom: 18, opacity: 0.8 }}>
        Select a notice type, enter values, then generate a draft response letter.
      </p>
      <NoticeWizard />
    </main>
  )
}

===== FILE: /components/PreviewPanel.tsx =====
'use client'

export default function PreviewPanel({ value }: { value: string }) {
  return (
    <div style={{ border: '1px solid #333', borderRadius: 10, padding: 12, background: '#0b0b0b' }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', gap: 12, marginBottom: 10 }}>
        <strong>Preview</strong>
        <button
          type="button"
          onClick={() => navigator.clipboard.writeText(value)}
          style={{
            border: '1px solid #444',
            background: '#111',
            color: '#fff',
            padding: '6px 10px',
            borderRadius: 8,
            cursor: 'pointer',
          }}
        >
          Copy
        </button>
      </div>
      <pre style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-word', margin: 0, fontSize: 14, lineHeight: 1.4 }}>
        {value || '—'}
      </pre>
    </div>
  )
}

===== FILE: /components/NoticeFormFields.tsx =====
'use client'

import { NoticeType, CP14Data, CP2000Data, CP501Data } from '../types'

type Common = {
  noticeNumber: string
  noticeDate: string
  taxYear: string
}

export type FormState =
  | ({ noticeType: NoticeType.CP14 } & Common & {
      balanceDue: string
      paymentIntent: 'pay_now' | 'installment_plan' | 'dispute'
      paymentDate?: string
      disputeExplanation?: string
    })
  | ({ noticeType: NoticeType.CP2000 } & Common & {
      underreportedAmount: string
      proposedTaxDue: string
      disagreementReason: 'already_reported' | 'incorrect_amount' | 'not_my_income' | 'other'
      disagreementExplanation?: string
    })
  | ({ noticeType: NoticeType.CP501 } & Common & {
      balanceDue: string
      paymentIntent: 'pay_now' | 'installment_plan' | 'dispute'
      paymentDate?: string
      disputeExplanation?: string
    })

export function toNoticeData(state: FormState): CP14Data | CP2000Data | CP501Data {
  const common = {
    noticeNumber: state.noticeNumber,
    noticeDate: state.noticeDate,
    taxYear: state.taxYear,
  }

  if (state.noticeType === NoticeType.CP14) {
    return {
      ...common,
      balanceDue: Number(state.balanceDue || 0),
      paymentIntent: state.paymentIntent,
      paymentDate: state.paymentDate || undefined,
      disputeExplanation: state.disputeExplanation || undefined,
    }
  }

  if (state.noticeType === NoticeType.CP2000) {
    return {
      ...common,
      underreportedAmount: Number(state.underreportedAmount || 0),
      proposedTaxDue: Number(state.proposedTaxDue || 0),
      disagreementReason: state.disagreementReason,
      disagreementExplanation: state.disagreementExplanation || undefined,
    }
  }

  return {
    ...common,
    balanceDue: Number(state.balanceDue || 0),
    paymentIntent: state.paymentIntent,
    paymentDate: state.paymentDate || undefined,
    disputeExplanation: state.disputeExplanation || undefined,
  }
}

export function CommonFields(props: {
  state: FormState
  onChange: (patch: Partial<FormState>) => void
}) {
  const { state, onChange } = props

  return (
    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12 }}>
      <label style={{ display: 'grid', gap: 6 }}>
        <span>Notice Number</span>
        <input
          value={state.noticeNumber}
          onChange={(e) => onChange({ noticeNumber: e.target.value } as any)}
          style={inputStyle}
          placeholder="CP14-1234567"
        />
      </label>

      <label style={{ display: 'grid', gap: 6 }}>
        <span>Notice Date</span>
        <input
          type="date"
          value={state.noticeDate}
          onChange={(e) => onChange({ noticeDate: e.target.value } as any)}
          style={inputStyle}
        />
      </label>

      <label style={{ display: 'grid', gap: 6 }}>
        <span>Tax Year</span>
        <input
          value={state.taxYear}
          onChange={(e) => onChange({ taxYear: e.target.value } as any)}
          style={inputStyle}
          placeholder="2023"
        />
      </label>
    </div>
  )
}

export function CP14Fields(props: { state: Extract<FormState, { noticeType: NoticeType.CP14 }>; onChange: (patch: any) => void }) {
  const { state, onChange } = props
  return (
    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginTop: 12 }}>
      <label style={{ display: 'grid', gap: 6 }}>
        <span>Balance Due</span>
        <input value={state.balanceDue} onChange={(e) => onChange({ balanceDue: e.target.value })} style={inputStyle} placeholder="1234.56" />
      </label>

      <label style={{ display: 'grid', gap: 6 }}>
        <span>Payment Intent</span>
        <select value={state.paymentIntent} onChange={(e) => onChange({ paymentIntent: e.target.value })} style={inputStyle}>
          <option value="pay_now">Pay now</option>
          <option value="installment_plan">Installment plan</option>
          <option value="dispute">Dispute</option>
        </select>
      </label>

      {state.paymentIntent === 'pay_now' && (
        <label style={{ display: 'grid', gap: 6 }}>
          <span>Payment Date (optional)</span>
          <input type="date" value={state.paymentDate || ''} onChange={(e) => onChange({ paymentDate: e.target.value })} style={inputStyle} />
        </label>
      )}

      {state.paymentIntent === 'dispute' && (
        <label style={{ display: 'grid', gap: 6, gridColumn: '1 / -1' }}>
          <span>Dispute Explanation (optional)</span>
          <textarea value={state.disputeExplanation || ''} onChange={(e) => onChange({ disputeExplanation: e.target.value })} style={textareaStyle} />
        </label>
      )}
    </div>
  )
}

export function CP2000Fields(props: { state: Extract<FormState, { noticeType: NoticeType.CP2000 }>; onChange: (patch: any) => void }) {
  const { state, onChange } = props
  return (
    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginTop: 12 }}>
      <label style={{ display: 'grid', gap: 6 }}>
        <span>Underreported Amount</span>
        <input value={state.underreportedAmount} onChange={(e) => onChange({ underreportedAmount: e.target.value })} style={inputStyle} placeholder="5000.00" />
      </label>

      <label style={{ display: 'grid', gap: 6 }}>
        <span>Proposed Tax Due</span>
        <input value={state.proposedTaxDue} onChange={(e) => onChange({ proposedTaxDue: e.target.value })} style={inputStyle} placeholder="1200.00" />
      </label>

      <label style={{ display: 'grid', gap: 6 }}>
        <span>Disagreement Reason</span>
        <select value={state.disagreementReason} onChange={(e) => onChange({ disagreementReason: e.target.value })} style={inputStyle}>
          <option value="already_reported">Already reported</option>
          <option value="incorrect_amount">Incorrect amount</option>
          <option value="not_my_income">Not my income</option>
          <option value="other">Other</option>
        </select>
      </label>

      <label style={{ display: 'grid', gap: 6, gridColumn: '1 / -1' }}>
        <span>Explanation (optional)</span>
        <textarea value={state.disagreementExplanation || ''} onChange={(e) => onChange({ disagreementExplanation: e.target.value })} style={textareaStyle} />
      </label>
    </div>
  )
}

export function CP501Fields(props: { state: Extract<FormState, { noticeType: NoticeType.CP501 }>; onChange: (patch: any) => void }) {
  // same shape as CP14 in this version
  return <CP14Fields state={props.state as any} onChange={props.onChange} />
}

const inputStyle: React.CSSProperties = {
  border: '1px solid #333',
  borderRadius: 8,
  padding: '10px 10px',
  background: '#0f0f0f',
  color: '#fff',
}

const textareaStyle: React.CSSProperties = {
  ...inputStyle,
  minHeight: 110,
  resize: 'vertical',
}

===== FILE: /components/NoticeWizard.tsx =====
'use client'

import { useMemo, useState } from 'react'
import { NoticeType } from '../types'
import { supportedNotices } from '../lib/notices'
import { generateLetter } from '../lib/templates'
import PreviewPanel from './PreviewPanel'
import { CommonFields, CP14Fields, CP2000Fields, CP501Fields, FormState, toNoticeData } from './NoticeFormFields'

function firstSupported(): NoticeType {
  // Only types wired in templates.ts right now
  const allowed = new Set([NoticeType.CP14, NoticeType.CP2000, NoticeType.CP501])
  const found = supportedNotices.find((n) => allowed.has(n.type))
  return found?.type ?? NoticeType.CP14
}

export default function NoticeWizard() {
  const [noticeType, setNoticeType] = useState<NoticeType>(firstSupported())

  const [state, setState] = useState<FormState>(() => ({
    noticeType: NoticeType.CP14,
    noticeNumber: '',
    noticeDate: '',
    taxYear: '',
    balanceDue: '',
    paymentIntent: 'pay_now',
    paymentDate: '',
    disputeExplanation: '',
  } as any))

  const [output, setOutput] = useState<string>('')

  const allowedNotices = useMemo(() => {
    const allowed = new Set([NoticeType.CP14, NoticeType.CP2000, NoticeType.CP501])
    return supportedNotices.filter((n) => allowed.has(n.type))
  }, [])

  function setPatch(patch: Partial<FormState>) {
    setState((prev) => ({ ...prev, ...patch } as any))
  }

  function changeType(next: NoticeType) {
    setNoticeType(next)
    setOutput('')

    if (next === NoticeType.CP14) {
      setState({
        noticeType: NoticeType.CP14,
        noticeNumber: '',
        noticeDate: '',
        taxYear: '',
        balanceDue: '',
        paymentIntent: 'pay_now',
        paymentDate: '',
        disputeExplanation: '',
      } as any)
      return
    }

    if (next === NoticeType.CP2000) {
      setState({
        noticeType: NoticeType.CP2000,
        noticeNumber: '',
        noticeDate: '',
        taxYear: '',
        underreportedAmount: '',
        proposedTaxDue: '',
        disagreementReason: 'already_reported',
        disagreementExplanation: '',
      } as any)
      return
    }

    setState({
      noticeType: NoticeType.CP501,
      noticeNumber: '',
      noticeDate: '',
      taxYear: '',
      balanceDue: '',
      paymentIntent: 'pay_now',
      paymentDate: '',
      disputeExplanation: '',
    } as any)
  }

  function onGenerate() {
    try {
      const data = toNoticeData(state as any)
      const letter = generateLetter(noticeType, data as any)
      setOutput(letter)
    } catch (e: any) {
      setOutput(`ERROR: ${e?.message || String(e)}`)
    }
  }

  return (
    <div style={{ display: 'grid', gridTemplateColumns: '1.1fr 0.9fr', gap: 18 }}>
      <div style={{ border: '1px solid #333', borderRadius: 10, padding: 14, background: '#0b0b0b' }}>
        <div style={{ display: 'flex', gap: 12, alignItems: 'center', marginBottom: 12 }}>
          <label style={{ display: 'grid', gap: 6, flex: 1 }}>
            <span>Notice Type</span>
            <select
              value={noticeType}
              onChange={(e) => changeType(e.target.value as any)}
              style={{
                border: '1px solid #333',
                borderRadius: 8,
                padding: '10px 10px',
                background: '#0f0f0f',
                color: '#fff',
              }}
            >
              {allowedNotices.map((n) => (
                <option key={n.type} value={n.type}>
                  {n.label}
                </option>
              ))}
            </select>
          </label>

          <button
            type="button"
            onClick={onGenerate}
            style={{
              marginTop: 22,
              border: '1px solid #444',
              background: '#111',
              color: '#fff',
              padding: '10px 14px',
              borderRadius: 10,
              cursor: 'pointer',
              fontWeight: 700,
            }}
          >
            Generate
          </button>
        </div>

        <CommonFields state={state as any} onChange={(p) => setPatch(p as any)} />

        {noticeType === NoticeType.CP14 && <CP14Fields state={state as any} onChange={setPatch} />}
        {noticeType === NoticeType.CP2000 && <CP2000Fields state={state as any} onChange={setPatch} />}
        {noticeType === NoticeType.CP501 && <CP501Fields state={state as any} onChange={setPatch} />}
      </div>

      <PreviewPanel value={output} />
    </div>
  )
}
