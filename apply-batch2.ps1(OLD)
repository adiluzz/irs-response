# apply-batch2.ps1
# Phase 2 â€“ Batch 2 installer
# Parses ===== FILE: /path ===== blocks from PHASE2_PAYLOAD.TXT

$ErrorActionPreference = "Stop"

$root = "C:\tac-response"
$payloadPath = Join-Path $root "PHASE2_PAYLOAD.TXT"

if (!(Test-Path $payloadPath)) {
  throw "PHASE2_PAYLOAD.TXT not found in $root"
}

$lines = Get-Content -LiteralPath $payloadPath -Encoding UTF8

$blocks = @()
$currentPath = $null
$currentContent = @()

function FlushBlock {
  if ($currentPath) {
    $blocks += [PSCustomObject]@{
      Path = $currentPath
      Content = ($currentContent -join "`r`n")
    }
  }
}

foreach ($line in $lines) {
  if ($line -match '^\s*===== FILE:\s*(.+?)\s*=====\s*$') {
    FlushBlock
    $currentPath = $Matches[1].TrimStart('/').Trim()
    $currentContent = @()
  } else {
    if ($currentPath) {
      $currentContent += $line
    }
  }
}

FlushBlock

if ($blocks.Count -eq 0) {
  throw "No FILE blocks found in payload."
}

Write-Host "Applying Batch 2 ($($blocks.Count) files)..."

foreach ($block in $blocks) {
  $dest = Join-Path $root $block.Path
  $dir = Split-Path $dest -Parent

  if (!(Test-Path $dir)) {
    New-Item -ItemType Directory -Path $dir -Force | Out-Null
    Write-Host "Created folder: $dir"
  }

  $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
  [System.IO.File]::WriteAllText($dest, $block.Content, $utf8NoBom)

  Write-Host "Wrote: $dest"
}

Write-Host ""
Write-Host "Batch 2 complete."
Write-Host "Next step:"
Write-Host "  cd C:\tac-response"
Write-Host "  npm run build"
